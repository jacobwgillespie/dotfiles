#!/bin/bash

max_retry=10

for i in $(seq 1 $max_retry); do
  recent_folder=$(find "$HOME/.cursor-server/bin/" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | head -n"$i" | tail -1)
  if [[ -z ${recent_folder} ]]; then
    echo "Cursor remote folder not found"
    exit 1
  fi

  script="$recent_folder/bin/remote-cli/cursor"
  if [[ ! -x ${script} ]]; then
    echo "Cursor remote script not found"
    exit 1
  fi

  socket=$(find /run/user/$UID/ -mindepth 1 -maxdepth 1 -name 'vscode-ipc-*' 2>/dev/null | head -n"$i" | tail -1)
  if [[ -z ${socket} ]]; then
    echo "Cursor IPC socket not found"
    exit 1
  fi

  export VSCODE_IPC_HOOK_CLI=${socket}

  if ${script} "$@" 2>/dev/null; then
    exit 0
  fi
done

echo "Failed to find valid Cursor connection"
